<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - Siparişler</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #4CAF50; color: white; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .delete-btn { background-color: #f44336; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
    .delete-btn:hover { background-color: #da190b; }
  </style>
</head>
<body>
  <h1>Admin Panel - Toplu Alım Siparişleri</h1>
  <button id="back-to-home" style="margin: 10px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Ana Sayfaya Dön</button>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Ad Soyad</th>
        <th>E-posta</th>
        <th>Kart No</th>
        <th>Son Kullanma</th>
        <th>CVC</th>
        <th>Tarih</th>
        <th>İşlem</th> </tr>
    </thead>
    <tbody id="orders-body">
      <tr><td colspan="8">Yükleniyor...</td></tr> </tbody>
  </table>

  <script>
    const BASE_URL = 'http://localhost:5001/api'; // BASE_URL tanımını ekleyin
    
    function getUserToken() { // Token alma fonksiyonunu ekleyin
        return localStorage.getItem('userToken');
    }

    async function loadOrders() {
      const tbody = document.getElementById('orders-body');
      const token = getUserToken(); // Token'ı al

      if (!token) {
          tbody.innerHTML = '<tr><td colspan="8">Yönetici paneline erişmek için giriş yapmalısınız.</td></tr>';
          console.error("Token yok, admin paneline erişim engellendi.");
          // Kullanıcıyı login sayfasına yönlendirebilirsiniz
          setTimeout(() => { window.location.href = 'login.html'; }, 2000);
          return;
      }

      try {
        const res = await fetch(`${BASE_URL}/orders`, { // BASE_URL kullanıldı
            headers: {
                'Authorization': `Bearer ${token}` // TOKEN BURAYA EKLENDİ!
            }
        });
        const data = await res.json();

        // Eğer backend'den 401/403 gibi bir hata dönerse
        if (!res.ok && (response.status === 401 || response.status === 403)) {
            tbody.innerHTML = '<tr><td colspan="8">Yetkisiz erişim. Lütfen tekrar giriş yapın.</td></tr>';
            removeUserToken(); // Geçersiz token'ı sil
            setTimeout(() => { window.location.href = 'login.html'; }, 2000);
            return;
        }

        if (!data.success) {
          tbody.innerHTML = '<tr><td colspan="8">Veri alınamadı</td></tr>';
          return;
        }

        if (data.orders.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8">Sipariş bulunamadı</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        data.orders.forEach(order => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${order.id}</td> <td>${order.name}</td>
            <td>${order.email}</td>
            <td>${order.card}</td>
            <td>${order.exp}</td>
            <td>${order.cvc}</td>
            <td>${order.created_at}</td>
            <td><button class="delete-btn" data-order-id="${order.id}">Sil</button></td> `;
          tbody.appendChild(tr);
        });

        attachDeleteEventListeners();

      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="8">Sunucuya ulaşılamadı</td></tr>';
        console.error("Siparişler yüklenirken hata:", e);
      }
    }

    async function deleteOrder(orderId) {
        if (!confirm(`Sipariş ID: ${orderId} gerçekten silmek istiyor musunuz?`)) {
            return;
        }

        const token = getUserToken(); // Token'ı al
        if (!token) {
            alert("Giriş yapmadığınız için silme işlemi yapılamadı.");
            setTimeout(() => { window.location.href = 'login.html'; }, 1500);
            return;
        }

        try {
            const response = await fetch(`${BASE_URL}/orders/${orderId}`, { // BASE_URL kullanıldı
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}` // TOKEN BURAYA EKLENDİ!
                }
            });

            const data = await response.json();

            if (response.ok) { // HTTP status 200-299
                alert(data.message);
                loadOrders();
            } else if (response.status === 401 || response.status === 403) {
                alert("Yetkisiz işlem. Lütfen tekrar giriş yapın.");
                removeUserToken();
                setTimeout(() => { window.location.href = 'login.html'; }, 1500);
            }
            else {
                alert(`Silme başarısız: ${data.message}`);
            }
        } catch (error) {
            console.error("Silme isteği gönderilirken hata oluştu:", error);
            alert("Sipariş silinirken bir hata oluştu.");
        }
    }

    function attachDeleteEventListeners() {
        const deleteButtons = document.querySelectorAll('.delete-btn');
        deleteButtons.forEach(button => {
            button.removeEventListener('click', handleButtonClick);
            button.addEventListener('click', handleButtonClick);
        });
    }

    function handleButtonClick(event) {
        const orderId = event.target.dataset.orderId;
        deleteOrder(orderId);
    }

    // Ana sayfaya dön butonu
    document.getElementById('back-to-home').addEventListener('click', () => {
        window.location.href = 'index.html';
    });

    // Sayfa yüklendiğinde siparişleri yükle
    window.onload = loadOrders;
  </script>
</body>
</html>